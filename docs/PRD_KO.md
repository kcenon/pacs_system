# 제품 요구사항 정의서 - PACS 시스템

> **버전:** 0.1.1.0
> **최종 수정일:** 2025-12-07
> **언어:** [English](PRD.md) | **한국어**

---

## 목차

- [요약](#요약)
- [제품 비전](#제품-비전)
- [대상 사용자](#대상-사용자)
- [기능 요구사항](#기능-요구사항)
- [비기능 요구사항](#비기능-요구사항)
- [시스템 아키텍처 요구사항](#시스템-아키텍처-요구사항)
- [DICOM 적합성 요구사항](#dicom-적합성-요구사항)
- [통합 요구사항](#통합-요구사항)
- [보안 요구사항](#보안-요구사항)
- [성능 요구사항](#성능-요구사항)
- [개발 단계](#개발-단계)
- [성공 지표](#성공-지표)
- [위험 및 완화 방안](#위험-및-완화-방안)
- [부록](#부록)

---

## 요약

### 제품명
PACS 시스템 (Picture Archiving and Communication System)

### 제품 설명
외부 DICOM 라이브러리 없이 kcenon 에코시스템만을 활용하여 구축된 운영 환경 수준의 C++20 PACS 구현체입니다. 이 시스템은 DICOM 표준을 처음부터 구현하여 기존 에코시스템 컴포넌트의 고성능 인프라를 활용하면서 코드베이스에 대한 완전한 제어권을 제공합니다.

### 핵심 차별화 요소
- **외부 DICOM 의존성 제로**: kcenon 에코시스템만을 사용한 순수 구현
- **고성능**: SIMD 가속, 락프리 큐, 비동기 I/O
- **완전한 에코시스템 통합**: 6개 기존 시스템과의 네이티브 통합
- **운영 환경 수준**: 포괄적인 CI/CD, 새니타이저, 품질 메트릭

---

## 제품 비전

### 비전 선언문
의료 영상 워크플로우에 대한 완전한 투명성과 커스터마이즈 가능성을 제공하면서, kcenon 에코시스템의 역량을 입증하는 완전히 제어 가능한 고성능 PACS 솔루션을 만듭니다.

### 전략적 목표

| 목표 | 설명 | 성공 기준 |
|------|------|----------|
| **독립성** | 외부 DICOM 라이브러리 의존성 제거 | GPL/LGPL 의존성 제로 |
| **성능** | DCMTK 성능과 동등 또는 그 이상 | ≥100 MB/s 이미지 저장 |
| **에코시스템** | 기존 시스템 최대 재사용 | ≥80% 인프라 재사용 |
| **적합성** | DICOM 적합성 요구사항 충족 | 적합성 테스트 통과 |
| **품질** | 에코시스템 품질 표준 충족 | CI/CD 그린, 80%+ 커버리지 |

---

## 대상 사용자

### 주요 사용자

#### 1. 의료 IT 개발자
- **프로필**: 의료 영상 애플리케이션을 구축하는 소프트웨어 개발자
- **필요사항**:
  - 잘 문서화된 DICOM API
  - 기존 시스템과의 쉬운 통합
  - 커스터마이즈 가능한 DICOM 서비스
- **고충점**:
  - 복잡한 DCMTK 학습 곡선
  - GPL 라이브러리와의 라이선스 우려
  - 제한된 커스터마이즈 옵션

#### 2. 의료 장비 통합 엔지니어
- **프로필**: 영상 장비를 PACS에 연결하는 엔지니어
- **필요사항**:
  - 안정적인 Storage SCP
  - Modality Worklist 지원
  - MPPS 통합
- **고충점**:
  - 상호운용성 문제
  - 제한된 디버깅 도구
  - 복잡한 프로토콜 디버깅

#### 3. 연구 기관
- **프로필**: 의료 영상 분야의 학술 연구자
- **필요사항**:
  - 수정을 위한 소스 코드 접근
  - 사용자 정의 SOP 클래스 지원
  - 유연한 데이터 추출
- **고충점**:
  - 블랙박스 상용 솔루션
  - 연구용 라이선스 제한

### 보조 사용자

#### 시스템 관리자
- 시스템 상태 및 성능 모니터링
- DICOM 서비스 구성
- 저장소 및 보존 정책 관리

#### 영상의학과 의사 (간접)
- PACS 뷰어 애플리케이션의 최종 사용자
- 빠른 이미지 검색 필요
- 안정적인 워크리스트 통합 필요

---

## 기능 요구사항

### FR-1: DICOM 코어 데이터 처리

#### FR-1.1: 데이터 요소 처리
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-1.1.1 | DICOM 데이터 요소 파싱 (태그, VR, 길이, 값) | 필수 | 1 |
| FR-1.1.2 | PS3.5에 따른 모든 34개 VR 타입 지원 (DICOM 2019b 포함) | 필수 | 1 |
| FR-1.1.3 | 중첩된 시퀀스(SQ) 요소의 재귀적 처리 | 필수 | 1 |
| FR-1.1.4 | 프라이빗 태그 및 프라이빗 크리에이터 요소 지원 | 권장 | 2 |
| FR-1.1.5 | 데이터 요소 일관성 검증 | 권장 | 2 |

#### FR-1.2: 데이터 세트 연산
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-1.2.1 | 데이터 요소 생성, 수정, 삭제 | 필수 | 1 |
| FR-1.2.2 | 태그 순서로 데이터 요소 순회 | 필수 | 1 |
| FR-1.2.3 | 태그, 키워드 또는 경로로 요소 검색 | 필수 | 1 |
| FR-1.2.4 | 데이터 세트 깊은 복사 및 이동 | 필수 | 1 |
| FR-1.2.5 | 충돌 해결을 통한 데이터 세트 병합 | 권장 | 2 |

#### FR-1.3: DICOM 파일 처리 (Part 10)
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-1.3.1 | 파일 메타 정보가 포함된 DICOM 파일 읽기 | 필수 | 1 |
| FR-1.3.2 | 적절한 프리앰블 및 접두사를 포함한 DICOM 파일 쓰기 | 필수 | 1 |
| FR-1.3.3 | Implicit VR Little Endian 지원 | 필수 | 1 |
| FR-1.3.4 | Explicit VR Little Endian 지원 | 필수 | 1 |
| FR-1.3.5 | Explicit VR Big Endian 지원 | 권장 | 2 |
| FR-1.3.6 | 읽기 시 Transfer Syntax 검증 | 필수 | 1 |

---

### FR-2: 네트워크 프로토콜

#### FR-2.1: 상위 레이어 프로토콜 (PDU)
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-2.1.1 | A-ASSOCIATE-RQ PDU 인코딩/디코딩 구현 | 필수 | 2 |
| FR-2.1.2 | A-ASSOCIATE-AC PDU 인코딩/디코딩 구현 | 필수 | 2 |
| FR-2.1.3 | A-ASSOCIATE-RJ PDU 인코딩/디코딩 구현 | 필수 | 2 |
| FR-2.1.4 | P-DATA-TF PDU 인코딩/디코딩 구현 | 필수 | 2 |
| FR-2.1.5 | A-RELEASE-RQ/RP PDU 인코딩/디코딩 구현 | 필수 | 2 |
| FR-2.1.6 | A-ABORT PDU 인코딩/디코딩 구현 | 필수 | 2 |
| FR-2.1.7 | PDU 프래그먼트 재조립 처리 | 필수 | 2 |

#### FR-2.2: 연결 관리
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-2.2.1 | 연결 상태 머신 관리 (8개 상태) | 필수 | 2 |
| FR-2.2.2 | 프레젠테이션 컨텍스트 협상 | 필수 | 2 |
| FR-2.2.3 | 다중 동시 연결 지원 | 필수 | 2 |
| FR-2.2.4 | 연결 타임아웃 처리 구현 | 필수 | 2 |
| FR-2.2.5 | 확장 협상 항목 지원 | 권장 | 3 |
| FR-2.2.6 | 사용자 인증 협상 구현 | 선택 | 4 |

#### FR-2.3: DIMSE 메시지 교환
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-2.3.1 | C-ECHO 요청/응답 구현 | 필수 | 2 |
| FR-2.3.2 | C-STORE 요청/응답 구현 | 필수 | 2 |
| FR-2.3.3 | C-FIND 요청/응답 구현 | 필수 | 3 |
| FR-2.3.4 | C-MOVE 요청/응답 구현 | 필수 | 3 |
| FR-2.3.5 | C-GET 요청/응답 구현 | 권장 | 3 |
| FR-2.3.6 | N-CREATE 요청/응답 구현 | 권장 | 4 | ✅ 구현됨 |
| FR-2.3.7 | N-SET 요청/응답 구현 | 권장 | 4 | ✅ 구현됨 |
| FR-2.3.8 | N-GET 요청/응답 구현 | 선택 | 4 | ✅ 구현됨 |
| FR-2.3.9 | N-EVENT-REPORT 요청/응답 구현 | 선택 | 4 | ✅ 구현됨 |
| FR-2.3.10 | N-ACTION 요청/응답 구현 | 선택 | 4 | ✅ 구현됨 |
| FR-2.3.11 | N-DELETE 요청/응답 구현 | 선택 | 4 | ✅ 구현됨 |

---

### FR-3: DICOM 서비스

#### FR-3.1: 검증 서비스
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-3.1.1 | Verification SCP 구현 (C-ECHO 응답자) | 필수 | 2 |
| FR-3.1.2 | Verification SCU 구현 (C-ECHO 개시자) | 필수 | 2 |
| FR-3.1.3 | 모든 연결 상태에서 검증 지원 | 필수 | 2 |

#### FR-3.2: 저장 서비스
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-3.2.1 | CT 이미지용 Storage SCP 구현 | 필수 | 3 |
| FR-3.2.2 | MR 이미지용 Storage SCP 구현 | 필수 | 3 |
| FR-3.2.3 | CR/DX 이미지용 Storage SCP 구현 | 필수 | 3 |
| FR-3.2.4 | 이차 캡처용 Storage SCP 구현 | 권장 | 3 |
| FR-3.2.5 | 이미지 전송용 Storage SCU 구현 | 필수 | 3 |
| FR-3.2.6 | 저장 커밋 처리 (선택 사항) | 선택 | 4 |
| FR-3.2.7 | 모든 표준 저장 SOP 클래스 지원 | 권장 | 4 |

#### FR-3.3: 조회/검색 서비스
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-3.3.1 | Patient Root Q/R 정보 모델 구현 | 필수 | 3 |
| FR-3.3.2 | Study Root Q/R 정보 모델 구현 | 필수 | 3 |
| FR-3.3.3 | 환자 레벨 조회 지원 (C-FIND) | 필수 | 3 |
| FR-3.3.4 | 스터디 레벨 조회 지원 (C-FIND) | 필수 | 3 |
| FR-3.3.5 | 시리즈 레벨 조회 지원 (C-FIND) | 필수 | 3 |
| FR-3.3.6 | 이미지 레벨 조회 지원 (C-FIND) | 필수 | 3 |
| FR-3.3.7 | 이미지 검색용 C-MOVE 구현 | 필수 | 3 |
| FR-3.3.8 | 이미지 검색용 C-GET 구현 | 권장 | 3 |

#### FR-3.4: Modality Worklist 서비스
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-3.4.1 | 예약된 절차용 MWL SCP 구현 | 권장 | 4 |
| FR-3.4.2 | 예약된 절차 단계 매칭 지원 | 권장 | 4 |
| FR-3.4.3 | 환자 인구통계 조회 지원 | 권장 | 4 |
| FR-3.4.4 | HIS/RIS 시스템과의 통합 (인터페이스) | 선택 | 4 |

#### FR-3.5: MPPS 서비스
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-3.5.1 | 절차 추적용 MPPS SCP 구현 | 권장 | 4 |
| FR-3.5.2 | MPPS 생성용 N-CREATE 지원 | 권장 | 4 |
| FR-3.5.3 | MPPS 수정용 N-SET 지원 | 권장 | 4 |
| FR-3.5.4 | 절차 상태 추적 (진행 중, 완료, 중단) | 권장 | 4 |

---

### FR-4: 저장 백엔드

#### FR-4.1: 파일 시스템 저장소
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-4.1.1 | 계층적 디렉토리 구조로 DICOM 파일 저장 | 필수 | 3 |
| FR-4.1.2 | 설정 가능한 파일 명명 규칙 지원 | 필수 | 3 |
| FR-4.1.3 | 원자적 파일 연산 구현 | 필수 | 3 |
| FR-4.1.4 | 중복 SOP 인스턴스 감지 처리 | 필수 | 3 |
| FR-4.1.5 | 파일 압축 지원 (선택 사항) | 선택 | 4 |

#### FR-4.2: 인덱스 데이터베이스
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-4.2.1 | 환자/스터디/시리즈/인스턴스 계층 인덱싱 | 필수 | 3 |
| FR-4.2.2 | 일반 속성에 의한 빠른 조회 지원 | 필수 | 3 |
| FR-4.2.3 | 참조 무결성 유지 | 필수 | 3 |
| FR-4.2.4 | 동시 읽기 작업 지원 | 필수 | 3 |
| FR-4.2.5 | 데이터베이스 복구 메커니즘 구현 | 권장 | 4 |

---

## 비기능 요구사항

### NFR-1: 성능

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|----------|
| NFR-1.1 | 이미지 저장 처리량 | ≥100 MB/s | 지속 C-STORE 속도 |
| NFR-1.2 | 동시 연결 수 | ≥100 | 동시 연결 수 |
| NFR-1.3 | 조회 응답 시간 (P95) | <100 ms | C-FIND 응답 지연 |
| NFR-1.4 | 연결 설정 | <50 ms | A-ASSOCIATE 왕복 시간 |
| NFR-1.5 | 기본 메모리 사용량 | <500 MB | 유휴 서버 메모리 |
| NFR-1.6 | 연결당 메모리 | <10 MB | 연결별 오버헤드 |

### NFR-2: 안정성

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|----------|
| NFR-2.1 | 시스템 가동 시간 | 99.9% | 월간 가용성 |
| NFR-2.2 | 데이터 무결성 | 100% | 데이터 손상 제로 |
| NFR-2.3 | 점진적 성능 저하 | 필수 | 고부하 상황에서 |
| NFR-2.4 | 오류 복구 | 자동 | 연결 실패 시 |
| NFR-2.5 | 트랜잭션 안전성 | ACID | 파일 연산 |

### NFR-3: 확장성

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|----------|
| NFR-3.1 | 수평 확장 | 지원 | 다중 인스턴스 |
| NFR-3.2 | 이미지 용량 | ≥1M 스터디 | 저장 인스턴스당 |
| NFR-3.3 | 선형 처리량 확장 | ≥80% 효율 | 추가 워커 시 |
| NFR-3.4 | 큐 용량 | ≥10K 작업 | 대기 중인 연산 |

### NFR-4: 보안

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|----------|
| NFR-4.1 | TLS 지원 | TLS 1.2/1.3 | DICOM TLS |
| NFR-4.2 | 접근 로깅 | 완전함 | 모든 DICOM 연산 |
| NFR-4.3 | 감사 추적 | HIPAA 준수 | PHI 접근 |
| NFR-4.4 | 입력 검증 | 100% | 모든 네트워크 입력 |
| NFR-4.5 | 메모리 안전성 | 누수 제로 | AddressSanitizer 클린 |

### NFR-5: 유지보수성

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|----------|
| NFR-5.1 | 코드 커버리지 | ≥80% | 라인 커버리지 |
| NFR-5.2 | 문서화 | 완전함 | 모든 공개 API |
| NFR-5.3 | CI/CD 파이프라인 | 100% 그린 | 모든 플랫폼 |
| NFR-5.4 | 스레드 안전성 | 검증됨 | ThreadSanitizer 클린 |
| NFR-5.5 | 모듈러 설계 | 낮은 결합도 | 인터페이스 중심 |

---

## 시스템 아키텍처 요구사항

### SAR-1: 모듈 의존성

```
┌─────────────────────────────────────────────────────────────────┐
│                        pacs_system                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐ │
│  │   services   │  │   network    │  │       storage          │ │
│  │              │  │              │  │                        │ │
│  │ Storage SCP  │  │ PDU Layer    │  │ File Storage           │ │
│  │ Q/R SCP      │◄─│ DIMSE Layer  │◄─│ Index Database         │ │
│  │ MWL SCP      │  │ Association  │  │                        │ │
│  │ MPPS SCP     │  │              │  │                        │ │
│  └──────┬───────┘  └──────┬───────┘  └───────────┬────────────┘ │
│         │                 │                      │              │
│  ┌──────▼─────────────────▼──────────────────────▼────────────┐ │
│  │                         core                                │ │
│  │  dicom_element | dicom_dataset | dicom_file | dictionary   │ │
│  └─────────────────────────┬───────────────────────────────────┘ │
│                            │                                     │
│  ┌─────────────────────────▼───────────────────────────────────┐ │
│  │                      encoding                                │ │
│  │     vr_types | transfer_syntax | implicit_vr | explicit_vr  │ │
│  └─────────────────────────┬───────────────────────────────────┘ │
│                            │                                     │
│  ┌─────────────────────────▼───────────────────────────────────┐ │
│  │                     integration                              │ │
│  │  container_adapter | network_adapter | thread_adapter       │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
┌───────▼───────┐    ┌──────────▼──────────┐    ┌───────▼───────┐
│network_system │    │   thread_system     │    │container_system│
│  (TCP/TLS)    │    │  (Thread Pool)      │    │(Serialization) │
└───────────────┘    └────────────────────┘    └───────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
┌───────▼───────┐    ┌──────────▼──────────┐    ┌───────▼───────┐
│ logger_system │    │ monitoring_system   │    │ common_system │
│   (Logging)   │    │    (Metrics)        │    │ (Foundation)  │
└───────────────┘    └────────────────────┘    └───────────────┘
```

### SAR-2: 컴포넌트 인터페이스 요구사항

| 컴포넌트 | 인터페이스 유형 | 설명 |
|----------|----------------|------|
| Storage Backend | 추상 인터페이스 | 교체 가능한 저장 구현체 |
| Association Handler | 옵저버 패턴 | 이벤트 기반 연결 라이프사이클 |
| DIMSE Processor | 전략 패턴 | 교체 가능한 메시지 핸들러 |
| PDU Codec | 템플릿 인터페이스 | 타입 안전 인코딩/디코딩 |
| Service Provider | 팩토리 패턴 | 동적 서비스 인스턴스화 |

### SAR-3: 스레드 모델 요구사항

| 요구사항 | 설명 |
|----------|------|
| Main IO Thread | 네트워크 연산을 위한 ASIO 이벤트 루프 |
| Worker Pool | DIMSE 메시지 처리를 위한 스레드 풀 |
| Storage Workers | 파일 I/O를 위한 전용 스레드 |
| Query Workers | 데이터베이스 조회를 위한 별도 풀 |
| Lock-free Queues | 스레드 간 통신 |

---

## DICOM 적합성 요구사항

### DCR-1: SOP 클래스 지원

#### 1단계 (MVP) - 검증
| SOP 클래스 | UID | 역할 |
|-----------|-----|------|
| Verification | 1.2.840.10008.1.1 | SCP/SCU |

#### 2단계 - 저장
| SOP 클래스 | UID | 역할 | 상태 |
|-----------|-----|------|------|
| CT Image Storage | 1.2.840.10008.5.1.4.1.1.2 | SCP/SCU | ✅ 구현됨 |
| MR Image Storage | 1.2.840.10008.5.1.4.1.1.4 | SCP/SCU | ✅ 구현됨 |
| CR Image Storage | 1.2.840.10008.5.1.4.1.1.1 | SCP/SCU | ✅ 구현됨 |
| Digital X-Ray | 1.2.840.10008.5.1.4.1.1.1.1 | SCP/SCU | ✅ 구현됨 |
| Secondary Capture | 1.2.840.10008.5.1.4.1.1.7 | SCP/SCU | ✅ 구현됨 |
| Ultrasound Image Storage | 1.2.840.10008.5.1.4.1.1.6.1 | SCP/SCU | ✅ 구현됨 |
| Ultrasound Multi-frame | 1.2.840.10008.5.1.4.1.1.3.1 | SCP/SCU | ✅ 구현됨 |
| XA Image Storage | 1.2.840.10008.5.1.4.1.1.12.1 | SCP/SCU | ✅ 구현됨 |
| Enhanced XA Image Storage | 1.2.840.10008.5.1.4.1.1.12.1.1 | SCP/SCU | ✅ 구현됨 |

#### 3단계 - 조회/검색
| SOP 클래스 | UID | 역할 |
|-----------|-----|------|
| Patient Root Q/R Find | 1.2.840.10008.5.1.4.1.2.1.1 | SCP/SCU |
| Patient Root Q/R Move | 1.2.840.10008.5.1.4.1.2.1.2 | SCP/SCU |
| Patient Root Q/R Get | 1.2.840.10008.5.1.4.1.2.1.3 | SCP/SCU |
| Study Root Q/R Find | 1.2.840.10008.5.1.4.1.2.2.1 | SCP/SCU |
| Study Root Q/R Move | 1.2.840.10008.5.1.4.1.2.2.2 | SCP/SCU |
| Study Root Q/R Get | 1.2.840.10008.5.1.4.1.2.2.3 | SCP/SCU |

#### 4단계 - 워크플로우
| SOP 클래스 | UID | 역할 |
|-----------|-----|------|
| Modality Worklist | 1.2.840.10008.5.1.4.31 | SCP |
| MPPS | 1.2.840.10008.3.1.2.3.3 | SCP |

### DCR-2: Transfer Syntax 지원

| Transfer Syntax | UID | 우선순위 | 상태 |
|-----------------|-----|----------|------|
| Implicit VR Little Endian | 1.2.840.10008.1.2 | 필수 | ✅ 구현됨 |
| Explicit VR Little Endian | 1.2.840.10008.1.2.1 | 필수 | ✅ 구현됨 |
| Explicit VR Big Endian | 1.2.840.10008.1.2.2 | 선택 | ✅ 구현됨 |
| JPEG Baseline | 1.2.840.10008.1.2.4.50 | 향후 | 🔮 계획됨 |
| JPEG Lossless | 1.2.840.10008.1.2.4.70 | 향후 | 🔮 계획됨 |
| JPEG 2000 Lossless | 1.2.840.10008.1.2.4.90 | 향후 | 🔮 계획됨 |
| JPEG 2000 | 1.2.840.10008.1.2.4.91 | 향후 | 🔮 계획됨 |
| RLE Lossless | 1.2.840.10008.1.2.5 | 향후 | 🔮 계획됨 |

---

## 통합 요구사항

### IR-1: 에코시스템 통합

| 시스템 | 통합 유형 | 용도 | 상태 |
|--------|----------|------|------|
| **common_system** | 기반 | Result<T>, 오류 코드, IExecutor | ✅ 통합됨 |
| **container_system** | 데이터 레이어 | DICOM 값 직렬화 | ✅ 통합됨 |
| **thread_system** | 동시성 | 워커 풀, 비동기 처리, jthread 지원, cancellation_token | ✅ 완전 마이그레이션 (v1.1.0) |
| **logger_system** | 로깅 | 감사 로그, 진단 | ✅ 통합됨 |
| **monitoring_system** | 관찰성 | 메트릭, 상태 확인 | ✅ 통합됨 |
| **network_system** | 네트워크 | TCP/TLS, 세션 관리, messaging_server | ✅ V2 구현 (선택적) |

#### 스레드 시스템 마이그레이션 (2025-12-07 완료)

시스템이 직접적인 `std::thread` 사용에서 `thread_system`으로 완전히 마이그레이션되었습니다:

| 컴포넌트 | 이전 | 현재 | 장점 |
|----------|------|------|------|
| Accept 루프 | `std::thread accept_thread_` | `accept_worker` (`thread_base` 상속) | jthread, cancellation_token |
| 워커 스레드 | 연결별 `std::thread` | `thread_adapter` 풀 | 통합 모니터링, 로드 밸런싱 |
| 종료 | 수동 스레드 관리 | 협력적 취소 | 45배 빠른 graceful shutdown |
| 통계 | 없음 | 통합 스레드 통계 | 완전한 관찰성 |

#### Network System V2 (선택적)

`network_system::messaging_server`를 사용하는 선택적 V2 구현이 제공됩니다:

| 컴포넌트 | 용도 |
|----------|------|
| `dicom_server_v2` | TCP 연결 관리에 `messaging_server` 사용 |
| `dicom_association_handler` | PDU 프레이밍, 상태 머신, 서비스 디스패칭 |
| 컴파일 플래그 | `PACS_WITH_NETWORK_SYSTEM` |

### IR-2: 외부 시스템 통합 (향후)

| 시스템 | 프로토콜 | 용도 |
|--------|----------|------|
| HIS/RIS | HL7 FHIR | 환자 인구통계 |
| WADO | HTTP | 웹 이미지 접근 |
| Viewer | DICOMweb | 이미지 검색 |

---

## 보안 요구사항

### SR-1: 데이터 보호

| 요구사항 | 구현 |
|----------|------|
| PHI 암호화 | 네트워크용 TLS 1.2+, 저장소용 AES |
| 접근 제어 | AE Title 화이트리스팅, 사용자 인증 |
| 감사 로깅 | 모든 DICOM 연산의 타임스탬프 포함 로깅 |
| 데이터 무결성 | 저장된 이미지의 체크섬 검증 |

### SR-2: 준수 사항

| 표준 | 요구사항 |
|------|----------|
| HIPAA | PHI 접근 로깅, 저장/전송 시 암호화 |
| GDPR | 정보 주체 접근권, 감사 추적 |
| IHE | ATNA (감사 추적 및 노드 인증) |

---

## 성능 요구사항

### PR-1: 벤치마크

| 메트릭 | 목표 | 측정값 | 상태 | 테스트 시나리오 |
|--------|------|--------|------|----------------|
| C-STORE 처리량 | ≥100 MB/s | 9,247 MB/s | ✅ 통과 | 512KB 이미지 |
| C-ECHO 처리량 | ≥100 msg/s | 89,964 msg/s | ✅ 통과 | 지속 트래픽 |
| 연결 지연시간 | <100 ms | ~1 ms | ✅ 통과 | 협상 포함 |
| Graceful 종료 | <5,000 ms | 110 ms | ✅ 통과 | 활성 연결 포함 |
| 연결당 메모리 | <10 MB | ~5 MB | ✅ 통과 | 활성 연결 |

*성능은 thread_system 마이그레이션 후 측정됨 (2025-12-07). 상세 내용은 [PERFORMANCE_RESULTS.md](PERFORMANCE_RESULTS.md) 참조.*

### PR-2: 확장성 목표

| 메트릭 | 목표 | 측정값 | 상태 |
|--------|------|--------|------|
| 동시 연결 | 100+ | 200+ | ✅ 초과 |
| 동시 C-ECHO 작업 | >50 ops/s | 124 ops/s | ✅ 초과 |
| 동시 C-STORE 작업 | >10 ops/s | 49.6 ops/s | ✅ 초과 |
| 스터디 데이터베이스 크기 | 1M+ 스터디 | 100K 테스트됨 | ✅ 진행 중 |
| 일일 수집량 | 50K+ 이미지 | 아키텍처 검증됨 | ✅ 검증됨 |

---

## 개발 단계

### 1단계: 기반 구축 (1-4주차)

**목표**: 핵심 DICOM 데이터 처리 수립

| 산출물 | 설명 | 수락 기준 |
|--------|------|----------|
| DICOM Element | 데이터 요소 파서/인코더 | 표준 VR 100% 파싱 |
| Data Set | 데이터 세트 컨테이너 | 모든 CRUD 연산 |
| DICOM File | Part 10 파일 리더/라이터 | DICOM 파일 읽기/쓰기 |
| Tag Dictionary | 표준 태그 정의 | 모든 PS3.6 태그 정의 |
| Unit Tests | 코어 모듈 테스트 | 80%+ 커버리지 |

**의존성**: container_system, common_system

### 2단계: 네트워크 프로토콜 (5-10주차)

**목표**: DICOM 상위 레이어 및 기본 DIMSE 구현

| 산출물 | 설명 | 수락 기준 |
|--------|------|----------|
| PDU Layer | 모든 PDU 타입 | 모든 PDU 인코드/디코드 |
| Association | 상태 머신, 협상 | 연결 테스트 통과 |
| C-ECHO | 검증 서비스 | DCMTK와 상호운용 |
| C-STORE | 기본 저장 | 모달리티에서 이미지 저장 |
| Integration Tests | 네트워크 테스트 | 모든 시나리오 통과 |

**의존성**: network_system, thread_system

### 3단계: 핵심 서비스 (11-16주차)

**목표**: 저장 및 조회/검색 구현

| 산출물 | 설명 | 수락 기준 |
|--------|------|----------|
| Storage SCP | 전체 저장 서비스 | CT/MR/CR 이미지 저장 |
| File Storage | 파일시스템 백엔드 | 계층적 저장 |
| Index DB | 조회 인덱스 | 빠른 속성 조회 |
| C-FIND | 조회 서비스 | 환자/스터디/시리즈/이미지 |
| C-MOVE | 검색 서비스 | 이미지 전송 |
| Conformance | 초기 테스트 | 기본 적합성 통과 |

**의존성**: 모든 시스템

### 4단계: 고급 서비스 (17-20주차)

**목표**: 워크플로우 서비스 추가 및 운영 환경 강화

| 산출물 | 설명 | 수락 기준 |
|--------|------|----------|
| Worklist SCP | MWL 서비스 | 예약된 절차 조회 |
| MPPS SCP | 절차 추적 | 절차 상태 추적 |
| C-GET | 대체 검색 | C-GET 모델 지원 |
| TLS | 보안 통신 | DICOM TLS 적합 |
| Production | 강화 | 성능 목표 달성 |

**의존성**: 모든 시스템

---

## 성공 지표

### 기술 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| DICOM 적합성 | 테스트된 SOP 클래스 100% | 적합성 테스트 스위트 |
| 코드 커버리지 | ≥80% | CI 커버리지 리포트 |
| CI/CD 성공률 | 100% 그린 | GitHub Actions |
| 새니타이저 클린 | 이슈 제로 | TSAN/ASAN/UBSAN |
| API 문서화 | 공개 API 100% | Doxygen 생성 |

### 성능 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| 저장 처리량 | ≥100 MB/s | 벤치마크 스위트 |
| 조회 지연 P95 | <100 ms | 부하 테스트 |
| 기본 메모리 | <500 MB | 프로파일링 |
| 동시 연결 | 100+ | 스트레스 테스트 |

### 품질 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| RAII 등급 | A | 정적 분석 |
| 스레드 안전성 | 검증됨 | ThreadSanitizer |
| 메모리 안전성 | 누수 제로 | AddressSanitizer |
| 정적 분석 | 경고 제로 | clang-tidy, cppcheck |

---

## 위험 및 완화 방안

### 기술적 위험

| 위험 | 영향 | 확률 | 완화 방안 |
|------|------|------|----------|
| DICOM 복잡성 과소평가 | 높음 | 중간 | MVP 접근, 점진적 전달 |
| 성능 목표 미달성 | 중간 | 낮음 | 에코시스템 최적화 활용 |
| 상호운용성 문제 | 높음 | 중간 | 조기 적합성 테스트 |
| 이미지 압축 복잡성 | 중간 | 높음 | 향후 단계로 연기 |

### 자원 위험

| 위험 | 영향 | 확률 | 완화 방안 |
|------|------|------|----------|
| 개발 시간 연장 | 중간 | 중간 | 명확한 단계 경계 |
| 범위 확대 | 중간 | 중간 | 엄격한 우선순위 관리 |
| 테스트 인프라 | 낮음 | 낮음 | 에코시스템 패턴 재사용 |

### 외부 위험

| 위험 | 영향 | 확률 | 완화 방안 |
|------|------|------|----------|
| DICOM 표준 업데이트 | 낮음 | 낮음 | 업데이트용 모듈러 설계 |
| 의존성 취약점 | 중간 | 낮음 | 정기 보안 스캔 |

---

## 부록

### 부록 A: DICOM VR 타입 매핑

| VR | 전체 이름 | container_system 타입 | 크기 |
|----|----------|----------------------|------|
| AE | Application Entity | string | 최대 16 |
| AS | Age String | string | 고정 4 |
| AT | Attribute Tag | uint32 | 4 |
| CS | Code String | string | 최대 16 |
| DA | Date | string | 고정 8 |
| DS | Decimal String | string → double | 최대 16 |
| DT | Date Time | string | 최대 26 |
| FL | Floating Point Single | float | 4 |
| FD | Floating Point Double | double | 8 |
| IS | Integer String | string → int64 | 최대 12 |
| LO | Long String | string | 최대 64 |
| LT | Long Text | string | 최대 10240 |
| OB | Other Byte | bytes | 가변 |
| OD | Other Double | bytes | 가변 |
| OF | Other Float | bytes | 가변 |
| OL | Other Long | bytes | 가변 |
| OW | Other Word | bytes | 가변 |
| PN | Person Name | string | 최대 64 |
| SH | Short String | string | 최대 16 |
| SL | Signed Long | int32 | 4 |
| SQ | Sequence | container (중첩) | 가변 |
| SS | Signed Short | int16 | 2 |
| ST | Short Text | string | 최대 1024 |
| TM | Time | string | 최대 14 |
| UI | Unique Identifier | string | 최대 64 |
| UL | Unsigned Long | uint32 | 4 |
| UN | Unknown | bytes | 가변 |
| US | Unsigned Short | uint16 | 2 |
| UT | Unlimited Text | string | 무제한 |

### 부록 B: 오류 코드 레지스트리

```
pacs_system 오류 코드: -800 ~ -899

DICOM 파싱 오류 (-800 ~ -819):
  -800: INVALID_DICOM_FILE
  -801: INVALID_VR
  -802: MISSING_REQUIRED_TAG
  -803: INVALID_TRANSFER_SYNTAX
  -804: INVALID_DATA_ELEMENT
  -805: SEQUENCE_ENCODING_ERROR

연결 오류 (-820 ~ -839):
  -820: ASSOCIATION_REJECTED
  -821: ASSOCIATION_ABORTED
  -822: NO_PRESENTATION_CONTEXT
  -823: INVALID_PDU
  -824: PDU_TOO_LARGE
  -825: ASSOCIATION_TIMEOUT

DIMSE 오류 (-840 ~ -859):
  -840: DIMSE_FAILURE
  -841: DIMSE_TIMEOUT
  -842: DIMSE_INVALID_RESPONSE
  -843: DIMSE_CANCELLED
  -844: DIMSE_STATUS_ERROR

저장 오류 (-860 ~ -879):
  -860: STORAGE_FAILED
  -861: DUPLICATE_SOP_INSTANCE
  -862: INVALID_SOP_CLASS
  -863: STORAGE_FULL
  -864: FILE_WRITE_ERROR

조회 오류 (-880 ~ -899):
  -880: QUERY_FAILED
  -881: NO_MATCHES_FOUND
  -882: TOO_MANY_MATCHES
  -883: INVALID_QUERY_LEVEL
  -884: DATABASE_ERROR
```

### 부록 C: 참고 자료

- DICOM 표준: https://www.dicomstandard.org/
- PS3.5 - 데이터 구조 및 인코딩
- PS3.6 - 데이터 딕셔너리
- PS3.7 - 메시지 교환
- PS3.8 - 네트워크 통신 지원
- PS3.4 - 서비스 클래스 사양

---

## 문서 이력

| 버전 | 날짜 | 작성자 | 변경 사항 |
|------|------|--------|----------|
| 1.0.0 | 2025-11-30 | kcenon@naver.com | 초기 PRD 릴리스 |
| 1.1.0 | 2025-12-07 | kcenon@naver.com | 완료된 기능 업데이트: 스레드 시스템 마이그레이션 (Epic #153), DIMSE-N 서비스 (#127), Ultrasound/XA 저장 (#128, #129), Explicit VR Big Endian (#126), 성능 결과 |

---

*문서 버전: 0.1.1.0*
*작성일: 2025-11-30*
*수정일: 2025-12-07*
*작성자: kcenon@naver.com*
