# 아키텍처 문서 - PACS 시스템

> **버전:** 1.0.0
> **최종 수정일:** 2025-11-30
> **언어:** [English](ARCHITECTURE.md) | **한국어**

---

## 목차

- [설계 철학](#설계-철학)
- [핵심 원칙](#핵심-원칙)
- [시스템 아키텍처](#시스템-아키텍처)
- [컴포넌트 아키텍처](#컴포넌트-아키텍처)
- [네트워크 아키텍처](#네트워크-아키텍처)
- [데이터 흐름 아키텍처](#데이터-흐름-아키텍처)
- [통합 아키텍처](#통합-아키텍처)
- [스레드 모델](#스레드-모델)
- [오류 처리 전략](#오류-처리-전략)
- [보안 아키텍처](#보안-아키텍처)

---

## 설계 철학

PACS 시스템은 네 가지 기본 원칙을 중심으로 설계되었습니다:

### 1. 에코시스템 우선 설계

핵심 컴포넌트를 다시 만드는 대신 검증된 kcenon 에코시스템 인프라 위에 구축합니다. 이를 통해 코드 재사용을 극대화하고, 일관성을 보장하며, 검증된 구현을 활용합니다.

**주요 설계 결정:**
- 모든 TCP/TLS 연산에 network_system 사용
- 데이터 직렬화에 container_system 활용
- 동시성에 thread_system 패턴 적용
- common_system의 Result<T> 패턴 채택

### 2. DICOM 표준 준수

모든 DICOM 호환 시스템과의 상호운용성을 보장하기 위해 공식 표준(PS3.x)에 따라 DICOM 프로토콜을 구현합니다.

**준수 전략:**
- PS3.5 (데이터 구조 및 인코딩) 준수
- PS3.7 (메시지 교환) 준수
- PS3.8 (네트워크 통신) 준수
- 정기적인 적합성 테스트

### 3. 외부 DICOM 의존성 제로

외부 DICOM 라이브러리(DCMTK, GDCM)에 대한 의존성을 제거하고, 에코시스템 컴포넌트를 사용하여 모든 DICOM 기능을 처음부터 구현합니다.

**이점:**
- 구현에 대한 완전한 제어
- GPL/LGPL 라이선스 우려 없음
- 에코시스템 통합에 최적화
- 완전한 투명성과 커스터마이즈 가능성

### 4. 운영 환경 수준 품질

다른 에코시스템 프로젝트와 동일한 품질 표준을 유지합니다:

**품질 특성:**
- RAII 등급 A (완벽한 리소스 관리)
- 메모리 누수 제로 (AddressSanitizer 검증)
- 데이터 레이스 제로 (ThreadSanitizer 검증)
- 80%+ 테스트 커버리지
- 완전한 API 문서화

---

## 핵심 원칙

### 모듈성

시스템은 명확한 책임을 가진 느슨하게 결합된 모듈로 구성됩니다:

```
┌─────────────────────────────────────────────────────────────────┐
│                        서비스 레이어                              │
│     (Storage SCP, Query/Retrieve SCP, Worklist SCP, MPPS SCP)   │
└────────────────────────────────┬────────────────────────────────┘
                                 │ uses
┌────────────────────────────────▼────────────────────────────────┐
│                        프로토콜 레이어                            │
│              (DIMSE Messages, PDU, Association)                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │ uses
┌────────────────────────────────▼────────────────────────────────┐
│                          코어 레이어                              │
│        (Data Element, Data Set, DICOM File, Dictionary)         │
└────────────────────────────────┬────────────────────────────────┘
                                 │ uses
┌────────────────────────────────▼────────────────────────────────┐
│                       인코딩 레이어                               │
│        (VR Types, Transfer Syntax, Implicit/Explicit VR)        │
└────────────────────────────────┬────────────────────────────────┘
                                 │ uses
┌────────────────────────────────▼────────────────────────────────┐
│                      통합 레이어                                  │
│    (Container Adapter, Network Adapter, Thread Adapter)         │
└────────────────────────────────┬────────────────────────────────┘
                                 │ uses
┌────────────────────────────────▼────────────────────────────────┐
│                     에코시스템 기반                               │
│  (common_system, container_system, network_system, thread_system)│
└─────────────────────────────────────────────────────────────────┘
```

### 확장성

기존 코드를 수정하지 않고도 새로운 DICOM 서비스와 SOP 클래스를 추가할 수 있습니다:

- 서비스 핸들러는 공통 인터페이스를 구현
- SOP 클래스는 딕셔너리에 등록
- Transfer Syntax는 코덱으로 플러그인 가능
- 저장 백엔드는 추상 인터페이스 구현

### 성능

여러 수준에서 최적화가 적용됩니다:

1. **네트워크**: ASIO를 통한 비동기 I/O (network_system)
2. **동시성**: 락프리 큐, 스레드 풀 (thread_system)
3. **직렬화**: 바이너리 인코딩, 가능한 경우 제로카피
4. **메모리**: RAII, 스마트 포인터, PDU용 메모리 풀링

### 안전성

최신 C++ 관용구를 통해 메모리 및 스레드 안전성 보장:

- 모든 리소스에 RAII (파일 핸들, 소켓, 연결)
- 스마트 포인터 (`std::shared_ptr`, `std::unique_ptr`)
- thread_system의 스레드 안전 큐
- 오류 전파를 위한 Result<T>

---

## 시스템 아키텍처

### 고수준 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PACS 시스템                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         서비스 프로바이더                                │ │
│  │                                                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐│ │
│  │  │   Storage   │  │   Query/    │  │  Worklist   │  │      MPPS       ││ │
│  │  │     SCP     │  │  Retrieve   │  │     SCP     │  │      SCP        ││ │
│  │  │             │  │     SCP     │  │             │  │                 ││ │
│  │  │ • C-STORE   │  │ • C-FIND    │  │ • C-FIND    │  │ • N-CREATE      ││ │
│  │  │ • Store     │  │ • C-MOVE    │  │ • Scheduled │  │ • N-SET         ││ │
│  │  │   Commit    │  │ • C-GET     │  │   Procedure │  │ • Status Track  ││ │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘│ │
│  │         │                │                │                  │         │ │
│  └─────────┼────────────────┼────────────────┼──────────────────┼─────────┘ │
│            │                │                │                  │           │
│  ┌─────────▼────────────────▼────────────────▼──────────────────▼─────────┐ │
│  │                      DIMSE 메시지 핸들러                                 │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │                    메시지 디스패처                                │   │ │
│  │  │  • C-ECHO Handler      • C-STORE Handler    • C-FIND Handler    │   │ │
│  │  │  • C-MOVE Handler      • C-GET Handler      • N-CREATE Handler  │   │ │
│  │  │  • N-SET Handler       • N-GET Handler      • N-EVENT Handler   │   │ │
│  │  └─────────────────────────────────────────────────────────────────┘   │ │
│  └─────────────────────────────────┬───────────────────────────────────────┘ │
│                                    │                                         │
│  ┌─────────────────────────────────▼───────────────────────────────────────┐ │
│  │                    연결 관리자                                           │ │
│  │                                                                          │ │
│  │  ┌────────────────┐  ┌────────────────┐  ┌──────────────────────────┐  │ │
│  │  │  상태 머신      │  │  프레젠테이션   │  │   PDU 인코더/디코더       │  │ │
│  │  │                │  │    컨텍스트     │  │                          │  │ │
│  │  │  PS3.8에 따른   │  │   협상         │  │  • A-ASSOCIATE-RQ/AC/RJ │  │ │
│  │  │  8상태 FSM     │  │                │  │  • P-DATA-TF             │  │ │
│  │  │                │  │                │  │  • A-RELEASE-RQ/RP       │  │ │
│  │  │                │  │                │  │  • A-ABORT               │  │ │
│  │  └────────────────┘  └────────────────┘  └──────────────────────────┘  │ │
│  └─────────────────────────────────┬───────────────────────────────────────┘ │
│                                    │                                         │
│  ┌─────────────────────────────────▼───────────────────────────────────────┐ │
│  │                      네트워크 전송 레이어                                 │ │
│  │                    (network_system 통합)                                 │ │
│  │                                                                          │ │
│  │  ┌────────────────┐  ┌────────────────┐  ┌──────────────────────────┐  │ │
│  │  │ TCP 서버       │  │ TCP 클라이언트  │  │   세션 관리자             │  │ │
│  │  │ (Port 11112)   │  │ (SCU Mode)     │  │                          │  │ │
│  │  └────────────────┘  └────────────────┘  └──────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                            저장 서브시스템                                    │
│                                                                              │
│  ┌────────────────────────────┐  ┌────────────────────────────────────────┐ │
│  │      파일 저장소            │  │           인덱스 데이터베이스           │ │
│  │                            │  │                                        │ │
│  │  • 계층적 구조              │  │  • 환자/스터디/시리즈/이미지 인덱스    │ │
│  │  • 원자적 연산              │  │  • 빠른 속성 조회                      │ │
│  │  • 중복 감지                │  │  • SQLite 백엔드                       │ │
│  └────────────────────────────┘  └────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           배포 옵션                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  옵션 1: 단일 인스턴스                                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         PACS 서버                                       │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────────────────┐│ │
│  │  │  Storage SCP    │  │  Q/R SCP        │  │  저장 백엔드              ││ │
│  │  │  Port 11112     │  │  Port 11112     │  │  /data/dicom             ││ │
│  │  └─────────────────┘  └─────────────────┘  └──────────────────────────┘│ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  옵션 2: 분산 (향후)                                                          │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                         │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │  Storage Node 1 │  │  Storage Node 2 │  │  Query Node             │ │ │
│  │  │  Port 11112     │  │  Port 11112     │  │  Port 11113             │ │ │
│  │  └────────┬────────┘  └────────┬────────┘  └────────────┬────────────┘ │ │
│  │           │                    │                        │              │ │
│  │           └────────────────────┼────────────────────────┘              │ │
│  │                                │                                        │ │
│  │                    ┌───────────▼───────────┐                           │ │
│  │                    │   공유 저장소          │                           │ │
│  │                    │   (NFS/S3)            │                           │ │
│  │                    └───────────────────────┘                           │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 컴포넌트 아키텍처

### 코어 모듈

코어 모듈은 기본적인 DICOM 데이터 구조를 제공합니다:

```
┌─────────────────────────────────────────────────────────────────┐
│                          코어 모듈                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      dicom_element                           ││
│  │                                                              ││
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐ ││
│  │  │   Tag    │  │    VR    │  │  Length  │  │    Value     │ ││
│  │  │ (4 bytes)│  │ (2 bytes)│  │ (2/4 b)  │  │  (variable)  │ ││
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────┘ ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      dicom_dataset                           ││
│  │                                                              ││
│  │  • Tag → DicomElement의 정렬된 맵                            ││
│  │  • O(log n) 태그별 조회                                      ││
│  │  • 반복자 지원 (태그 순서)                                   ││
│  │  • 시퀀스 (SQ) 중첩                                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                       dicom_file                             ││
│  │                                                              ││
│  │  ┌──────────────────┐  ┌─────────────────┐  ┌─────────────┐ ││
│  │  │  Preamble (128)  │  │  DICM Prefix    │  │  Meta Info  │ ││
│  │  └──────────────────┘  └─────────────────┘  └─────────────┘ ││
│  │                                                              ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │                    Data Set                              │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    dicom_dictionary                          ││
│  │                                                              ││
│  │  • 컴파일 타임 태그 상수                                     ││
│  │  • Tag → (VR, Name, VM) 조회                                ││
│  │  • 프라이빗 태그 등록                                        ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 인코딩 모듈

인코딩 모듈은 VR 인코딩과 Transfer Syntax를 처리합니다:

```
┌─────────────────────────────────────────────────────────────────┐
│                        인코딩 모듈                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                        vr_types                              ││
│  │                                                              ││
│  │  enum class vr_type {                                       ││
│  │      AE, AS, AT, CS, DA, DS, DT, FL, FD, IS, LO, LT,       ││
│  │      OB, OD, OF, OL, OW, PN, SH, SL, SQ, SS, ST, TM,       ││
│  │      UI, UL, UN, US, UT                                     ││
│  │  };                                                         ││
│  │                                                              ││
│  │  • VR 분류 (문자열, 숫자, 바이너리, 시퀀스)                  ││
│  │  • VR 제약 조건 (최대 길이, 패딩 문자)                       ││
│  │  • VR에서 컨테이너 타입으로 매핑                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    transfer_syntax                           ││
│  │                                                              ││
│  │  class transfer_syntax {                                    ││
│  │      uid: string                                            ││
│  │      is_implicit_vr: bool                                   ││
│  │      is_little_endian: bool                                 ││
│  │      is_encapsulated: bool                                  ││
│  │  };                                                         ││
│  │                                                              ││
│  │  정적 팩토리 메서드:                                         ││
│  │  • implicit_vr_little_endian()                              ││
│  │  • explicit_vr_little_endian()                              ││
│  │  • explicit_vr_big_endian()                                 ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      VR 코덱                                 ││
│  │                                                              ││
│  │  ┌──────────────────┐  ┌──────────────────────────────────┐ ││
│  │  │ implicit_vr_codec│  │      explicit_vr_codec           │ ││
│  │  │                  │  │                                  │ ││
│  │  │ • VR 필드 없음   │  │ • 2바이트 VR 필드                │ ││
│  │  │ • 4바이트 길이   │  │ • 2 또는 4바이트 길이            │ ││
│  │  │ • VR 조회        │  │ • 스트림에 VR 포함               │ ││
│  │  └──────────────────┘  └──────────────────────────────────┘ ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 네트워크 모듈

네트워크 모듈은 DICOM 상위 레이어 프로토콜을 구현합니다:

```
┌─────────────────────────────────────────────────────────────────┐
│                        네트워크 모듈                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                         PDU 레이어                           ││
│  │                                                              ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐││
│  │  │ pdu_encoder │ │ pdu_decoder │ │     PDU 타입            │││
│  │  │             │ │             │ │                         │││
│  │  │ • 바이트로   │ │ • 바이트에서│ │ • A-ASSOCIATE-RQ (0x01) │││
│  │  │   직렬화    │ │   파싱      │ │ • A-ASSOCIATE-AC (0x02) │││
│  │  │             │ │             │ │ • A-ASSOCIATE-RJ (0x03) │││
│  │  │             │ │             │ │ • P-DATA-TF (0x04)      │││
│  │  │             │ │             │ │ • A-RELEASE-RQ (0x05)   │││
│  │  │             │ │             │ │ • A-RELEASE-RP (0x06)   │││
│  │  │             │ │             │ │ • A-ABORT (0x07)        │││
│  │  └─────────────┘ └─────────────┘ └─────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      DIMSE 레이어                            ││
│  │                                                              ││
│  │  ┌──────────────────────────────────────────────────────────┐││
│  │  │                 dimse_message                             │││
│  │  │                                                           │││
│  │  │  ┌────────────┐  ┌────────────┐  ┌──────────────────────┐│││
│  │  │  │ Command Set│  │   Data Set │  │   메시지 타입        ││││
│  │  │  │            │  │ (optional) │  │                      ││││
│  │  │  │ • Command  │  │            │  │ • C-ECHO-RQ/RSP      ││││
│  │  │  │ • Message ID│  │            │  │ • C-STORE-RQ/RSP    ││││
│  │  │  │ • SOP Class │  │            │  │ • C-FIND-RQ/RSP     ││││
│  │  │  │ • Status    │  │            │  │ • C-MOVE-RQ/RSP     ││││
│  │  │  └────────────┘  └────────────┘  │ • C-GET-RQ/RSP       ││││
│  │  │                                  │ • N-CREATE-RQ/RSP    ││││
│  │  │                                  │ • N-SET-RQ/RSP       ││││
│  │  │                                  └──────────────────────┘│││
│  │  └──────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                   연결 관리자                                ││
│  │                                                              ││
│  │  ┌──────────────────────────────────────────────────────────┐││
│  │  │                  association                              │││
│  │  │                                                           │││
│  │  │  상태 머신 (PS3.8에 따른 8개 상태):                       │││
│  │  │                                                           │││
│  │  │  Sta1 ─► Sta2 ─► Sta3 ─► Sta5 ─► Sta6 ─► Sta7 ─► Sta1   │││
│  │  │  (유휴)  (TCP)  (대기)  (대기) (수립됨)  (대기) (유휴)    │││
│  │  │                                                           │││
│  │  │  메서드:                                                  │││
│  │  │  • connect()      - 연결 개시 (SCU)                       │││
│  │  │  • accept()       - 연결 수락 (SCP)                       │││
│  │  │  • release()      - 정상 해제                             │││
│  │  │  • abort()        - 즉시 중단                             │││
│  │  │  • send_dimse()   - DIMSE 메시지 전송                     │││
│  │  │  • receive_dimse()- DIMSE 메시지 수신                     │││
│  │  └──────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 네트워크 아키텍처

### DICOM 통신 흐름

```
┌────────────────┐                              ┌────────────────┐
│      SCU       │                              │      SCP       │
│  (모달리티)     │                              │    (PACS)      │
└───────┬────────┘                              └───────┬────────┘
        │                                               │
        │  1. TCP 연결                                  │
        │──────────────────────────────────────────────►│
        │                                               │
        │  2. A-ASSOCIATE-RQ                            │
        │  [Called AE, Calling AE, Contexts]           │
        │──────────────────────────────────────────────►│
        │                                               │
        │  3. A-ASSOCIATE-AC                            │
        │  [Accepted Contexts]                          │
        │◄──────────────────────────────────────────────│
        │                                               │
        │  4. P-DATA-TF (C-STORE-RQ Command)           │
        │──────────────────────────────────────────────►│
        │                                               │
        │  5. P-DATA-TF (C-STORE-RQ Data Set)          │
        │──────────────────────────────────────────────►│
        │                                               │
        │  6. P-DATA-TF (C-STORE-RSP)                  │
        │  [Status: Success]                            │
        │◄──────────────────────────────────────────────│
        │                                               │
        │  7. A-RELEASE-RQ                              │
        │──────────────────────────────────────────────►│
        │                                               │
        │  8. A-RELEASE-RP                              │
        │◄──────────────────────────────────────────────│
        │                                               │
        │  9. TCP 종료                                  │
        │──────────────────────────────────────────────►│
        │                                               │
```

### 다중 연결 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                      PACS 서버                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  TCP Acceptor (Port 11112)                 │  │
│  │                  (network_system::messaging_server)        │  │
│  └────────────────────────────┬──────────────────────────────┘  │
│                               │                                  │
│                               │ 새 연결                          │
│                               ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  세션 관리자                               │  │
│  │                                                            │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐           │  │
│  │  │ Session 1  │  │ Session 2  │  │ Session N  │  ...      │  │
│  │  │            │  │            │  │            │           │  │
│  │  │ Assoc ID:1 │  │ Assoc ID:2 │  │ Assoc ID:N │           │  │
│  │  │ AE: CT_01  │  │ AE: MR_02  │  │ AE: CR_03  │           │  │
│  │  │ State: Est │  │ State: Est │  │ State: Rel │           │  │
│  │  └────────────┘  └────────────┘  └────────────┘           │  │
│  └────────────────────────────┬──────────────────────────────┘  │
│                               │                                  │
│                               │ DIMSE 메시지                     │
│                               ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  워커 스레드 풀                             │  │
│  │                  (thread_system::thread_pool)              │  │
│  │                                                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
│  │  │ Worker 1 │  │ Worker 2 │  │ Worker 3 │  │ Worker N │  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 데이터 흐름 아키텍처

### 저장 흐름 (C-STORE)

```
┌─────────────────────────────────────────────────────────────────┐
│                     C-STORE 데이터 흐름                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  모달리티                                                        │
│     │                                                            │
│     │ C-STORE-RQ                                                 │
│     ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  1. PDU 디코드                                               ││
│  │     • P-DATA-TF PDU 파싱                                     ││
│  │     • DIMSE 프래그먼트 재조립                                 ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  2. DIMSE 파싱                                               ││
│  │     • Command Set 파싱                                       ││
│  │     • Data Set (이미지 데이터) 파싱                          ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  3. 검증                                                     ││
│  │     • SOP 클래스 확인                                        ││
│  │     • 필수 속성 확인                                         ││
│  │     • Transfer Syntax 검증                                   ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  4. 중복 확인                                                ││
│  │     • SOP Instance UID로 인덱스 조회                         ││
│  │     • 중복 정책 처리 (거부/교체)                              ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  5. 저장                                                     ││
│  │     • DICOM 파일을 저장소에 쓰기                              ││
│  │     • 인덱스 데이터베이스 업데이트                            ││
│  │     • (원자적 트랜잭션)                                      ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  6. 응답                                                     ││
│  │     • C-STORE-RSP 생성                                       ││
│  │     • Status: Success (0x0000)                               ││
│  │     • PDU Encoder를 통해 전송                                 ││
│  └─────────────────────────────────────────────────────────────┘│
│                               │                                  │
│                               ▼                                  │
│                           모달리티                               │
└─────────────────────────────────────────────────────────────────┘
```

### 조회 흐름 (C-FIND)

```
┌─────────────────────────────────────────────────────────────────┐
│                      C-FIND 데이터 흐름                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  뷰어                                                            │
│     │                                                            │
│     │ C-FIND-RQ (Query: PatientName=Doe*)                       │
│     ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  1. 조회 파싱                                                ││
│  │     • 조회 레벨 추출 (PATIENT/STUDY/SERIES/IMAGE)            ││
│  │     • 매칭 키 파싱                                           ││
│  │     • 반환 키 파싱                                           ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  2. SQL 조회 구성                                            ││
│  │     • DICOM 속성을 데이터베이스 컬럼에 매핑                   ││
│  │     • 와일드카드 처리 (*, ?)                                  ││
│  │     • 범위 조회 적용 (날짜)                                   ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  3. 조회 실행                                                ││
│  │     • 최적화된 SQL 실행                                      ││
│  │     • 제한 적용 (최대 매칭)                                   ││
│  │     • 결과 스트리밍                                          ││
│  └────────────────────────────┬────────────────────────────────┘│
│                               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  4. 결과 전송                                                ││
│  │     • 각 매칭에 대해:                                        ││
│  │         • C-FIND-RSP 구성 (Status: Pending)                 ││
│  │         • 매칭 속성 포함                                     ││
│  │         • 뷰어로 전송                                        ││
│  │     • 최종 C-FIND-RSP (Status: Success)                     ││
│  └─────────────────────────────────────────────────────────────┘│
│                               │                                  │
│                               ▼                                  │
│                            뷰어                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 통합 아키텍처

### 에코시스템 통합 맵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        에코시스템 통합                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                           pacs_system                                   │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │                    통합 레이어                                   │   │ │
│  │  │                                                                  │   │ │
│  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐ │   │ │
│  │  │  │ container_adapter │  │ network_adapter  │  │ thread_adapter │ │   │ │
│  │  │  │                   │  │                  │  │                │ │   │ │
│  │  │  │ • VR to value    │  │ • TCP 서버       │  │ • 작업 큐       │ │   │ │
│  │  │  │ • 직렬화          │  │ • TLS 지원       │  │ • 비동기 작업  │ │   │ │
│  │  │  │ • SQ 처리         │  │ • 세션           │  │ • 취소         │ │   │ │
│  │  │  └────────┬─────────┘  └────────┬─────────┘  └───────┬────────┘ │   │ │
│  │  │           │                     │                     │         │   │ │
│  │  └───────────┼─────────────────────┼─────────────────────┼─────────┘   │ │
│  └──────────────┼─────────────────────┼─────────────────────┼─────────────┘ │
│                 │                     │                     │               │
│                 ▼                     ▼                     ▼               │
│  ┌──────────────────────┐ ┌──────────────────────┐ ┌──────────────────────┐ │
│  │   container_system   │ │    network_system    │ │    thread_system     │ │
│  │                      │ │                      │ │                      │ │
│  │  • value_container   │ │  • messaging_server  │ │  • thread_pool       │ │
│  │  • 바이너리 직렬화    │ │  • messaging_client  │ │  • job_queue         │ │
│  │  • 타입 안전 값       │ │  • messaging_session │ │  • cancellation      │ │
│  │  • SIMD 가속          │ │  • TLS/SSL           │ │  • lock-free         │ │
│  └──────────────────────┘ └──────────────────────┘ └──────────────────────┘ │
│                 │                     │                     │               │
│                 ▼                     ▼                     ▼               │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                          common_system                                │  │
│  │                                                                       │  │
│  │  • Result<T> 패턴             • 오류 코드 레지스트리                   │  │
│  │  • IExecutor 인터페이스       • 이벤트 버스                            │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────┐                         ┌──────────────────────┐  │
│  │    logger_system     │                         │  monitoring_system   │  │
│  │                      │                         │                      │  │
│  │  • 비동기 로깅        │                         │  • 성능 메트릭        │  │
│  │  • 감사 추적          │                         │  • 상태 확인          │  │
│  │  • 다중 라이터        │                         │  • 분산 추적          │  │
│  │  • HIPAA 준수         │                         │                      │  │
│  └──────────────────────┘                         └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 스레드 모델

### 스레딩 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          스레드 모델                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         메인 스레드                                     │ │
│  │                                                                         │ │
│  │  • 구성 로딩                                                            │ │
│  │  • 서비스 초기화                                                        │ │
│  │  • 시그널 처리                                                          │ │
│  │  • 정상 종료 조율                                                       │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                      I/O 스레드 풀                                      │ │
│  │                   (network_system ASIO)                                 │ │
│  │                                                                         │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │ │
│  │  │  IO Thread 1 │  │  IO Thread 2 │  │  IO Thread N │                  │ │
│  │  │              │  │              │  │              │                  │ │
│  │  │ • Accept     │  │ • PDU 읽기   │  │ • PDU 쓰기   │                  │ │
│  │  │ • 읽기       │  │ • PDU 쓰기   │  │ • 읽기       │                  │ │
│  │  │ • 쓰기       │  │              │  │              │                  │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│                                      │ 작업                                  │
│                                      ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                     워커 스레드 풀                                      │ │
│  │                   (thread_system::thread_pool)                          │ │
│  │                                                                         │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │ │
│  │  │  Worker 1    │  │  Worker 2    │  │  Worker N    │                  │ │
│  │  │              │  │              │  │              │                  │ │
│  │  │ • C-STORE    │  │ • C-FIND     │  │ • C-MOVE     │                  │ │
│  │  │   처리       │  │   처리       │  │   처리       │                  │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                  │ │
│  │                                                                         │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │ │
│  │  │                   락프리 작업 큐                                   │  │ │
│  │  │              (thread_system::job_queue)                           │  │ │
│  │  └──────────────────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                      저장 스레드 풀                                     │ │
│  │                                                                         │ │
│  │  ┌──────────────┐  ┌──────────────┐                                    │ │
│  │  │  Storage 1   │  │  Storage 2   │                                    │ │
│  │  │              │  │              │                                    │ │
│  │  │ • 파일 I/O   │  │ • DB 인덱스   │                                    │ │
│  │  └──────────────┘  └──────────────┘                                    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                       로거 스레드                                       │ │
│  │                  (logger_system async)                                  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 오류 처리 전략

### 오류 전파

모든 오류는 common_system의 Result<T> 패턴을 사용하여 전파됩니다:

```cpp
// 오류 코드 등록 (-800 ~ -899)
namespace pacs::error_codes {
    // DICOM 파싱 오류 (-800 ~ -819)
    constexpr int INVALID_DICOM_FILE = -800;
    constexpr int INVALID_VR = -801;
    // ... (전체 목록은 PRD 참조)
}

// 오류 처리 예제
auto result = dicom_file::read("/path/to/file.dcm");
if (result.is_err()) {
    const auto& error = result.error();
    log_error("읽기 실패: {} (코드: {})", error.message, error.code);
    return result; // 오류 전파
}

// 성공 경로
auto& file = result.value();
```

### 오류 카테고리

| 카테고리 | 코드 범위 | 설명 |
|----------|-----------|------|
| 파싱 | -800 ~ -819 | DICOM 데이터 파싱 오류 |
| 연결 | -820 ~ -839 | 네트워크 연결 오류 |
| DIMSE | -840 ~ -859 | 메시지 교환 오류 |
| 저장 | -860 ~ -879 | 파일/데이터베이스 저장 오류 |
| 조회 | -880 ~ -899 | 조회 처리 오류 |

---

## 보안 아키텍처

### 인증 및 권한 부여

```
┌─────────────────────────────────────────────────────────────────┐
│                     보안 아키텍처                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    전송 보안                               │  │
│  │                                                            │  │
│  │  • TLS 1.2/1.3 암호화                                     │  │
│  │  • 인증서 검증                                            │  │
│  │  • 상호 인증 (선택 사항)                                  │  │
│  │  • 최신 암호 스위트                                       │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    접근 제어                               │  │
│  │                                                            │  │
│  │  • AE Title 화이트리스트                                  │  │
│  │  • IP 기반 필터링                                         │  │
│  │  • AE별 SOP 클래스 제한                                   │  │
│  │  • 연산 수준 권한                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    감사 로깅                               │  │
│  │                                                            │  │
│  │  • 모든 DICOM 연산 기록                                   │  │
│  │  • PHI 접근 추적                                          │  │
│  │  • 변조 방지 로그 저장                                    │  │
│  │  • 준수: HIPAA, GDPR, IHE ATNA                           │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

*문서 버전: 1.0.0*
*작성일: 2025-11-30*
*작성자: kcenon@naver.com*
