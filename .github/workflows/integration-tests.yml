name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Release]

    steps:
    - name: Checkout pacs_system
      uses: actions/checkout@v4
      with:
        path: pacs_system

    # Checkout all required kcenon ecosystem dependencies
    - name: Checkout common_system (Tier 0)
      uses: actions/checkout@v4
      with:
        repository: kcenon/common_system
        path: common_system

    - name: Checkout container_system (Tier 1)
      uses: actions/checkout@v4
      with:
        repository: kcenon/container_system
        path: container_system

    - name: Checkout thread_system (Tier 1)
      uses: actions/checkout@v4
      with:
        repository: kcenon/thread_system
        path: thread_system

    - name: Checkout logger_system (Tier 2)
      uses: actions/checkout@v4
      with:
        repository: kcenon/logger_system
        path: logger_system

    - name: Checkout monitoring_system (Tier 3)
      uses: actions/checkout@v4
      with:
        repository: kcenon/monitoring_system
        path: monitoring_system

    - name: Checkout network_system (Tier 4)
      uses: actions/checkout@v4
      with:
        repository: kcenon/network_system
        path: network_system

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: brew install sqlite3

    - name: Configure CMake
      working-directory: pacs_system
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DPACS_WARNINGS_AS_ERRORS=OFF \
          -DPACS_BUILD_TESTS=ON \
          -DPACS_BUILD_EXAMPLES=ON \
          -DPACS_BUILD_STORAGE=ON

    - name: Build
      working-directory: pacs_system
      run: cmake --build build -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

    - name: Run Unit Tests
      working-directory: pacs_system
      run: |
        cd build
        ctest -L unit --output-on-failure --timeout 60 || true

    - name: Run Integration Tests
      working-directory: pacs_system
      run: |
        cd build
        ctest -L integration --output-on-failure --timeout 300 || true

    - name: Run All Tests with JUnit Output
      working-directory: pacs_system
      run: |
        cd build
        mkdir -p test-results
        # Run core tests
        ./bin/core_tests --reporter junit --out test-results/core-tests.xml || true
        # Run encoding tests
        ./bin/encoding_tests --reporter junit --out test-results/encoding-tests.xml || true
        # Run network tests
        ./bin/network_tests --reporter junit --out test-results/network-tests.xml || true
        # Run services tests
        ./bin/services_tests --reporter junit --out test-results/services-tests.xml || true
        # Run storage tests
        ./bin/storage_tests --reporter junit --out test-results/storage-tests.xml || true
        # Run integration tests
        ./bin/pacs_integration_tests --reporter junit --out test-results/integration-tests.xml || true
        # Run E2E tests
        if [ -f ./bin/pacs_integration_e2e ]; then
          ./bin/pacs_integration_e2e --reporter junit --out test-results/e2e-tests.xml || true
        fi

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: pacs_system/build/test-results/*.xml
        retention-days: 30

    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v4
      if: always()
      with:
        report_paths: pacs_system/build/test-results/*.xml
        fail_on_failure: false
        include_passed: true
        detailed_summary: true

  binary-integration-tests:
    runs-on: ${{ matrix.os }}
    needs: build-and-test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout pacs_system
      uses: actions/checkout@v4
      with:
        path: pacs_system

    - name: Checkout common_system (Tier 0)
      uses: actions/checkout@v4
      with:
        repository: kcenon/common_system
        path: common_system

    - name: Checkout container_system (Tier 1)
      uses: actions/checkout@v4
      with:
        repository: kcenon/container_system
        path: container_system

    - name: Checkout thread_system (Tier 1)
      uses: actions/checkout@v4
      with:
        repository: kcenon/thread_system
        path: thread_system

    - name: Checkout logger_system (Tier 2)
      uses: actions/checkout@v4
      with:
        repository: kcenon/logger_system
        path: logger_system

    - name: Checkout monitoring_system (Tier 3)
      uses: actions/checkout@v4
      with:
        repository: kcenon/monitoring_system
        path: monitoring_system

    - name: Checkout network_system (Tier 4)
      uses: actions/checkout@v4
      with:
        repository: kcenon/network_system
        path: network_system

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: brew install sqlite3

    - name: Build with examples
      working-directory: pacs_system
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DPACS_WARNINGS_AS_ERRORS=OFF \
          -DPACS_BUILD_TESTS=ON \
          -DPACS_BUILD_EXAMPLES=ON \
          -DPACS_BUILD_STORAGE=ON
        cmake --build build -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

    - name: Generate test data
      working-directory: pacs_system
      run: |
        cd build
        if [ -f ./bin/generate_test_data ]; then
          ./bin/generate_test_data ../examples/integration_tests/test_data || true
        fi

    - name: Run Binary Integration Tests
      working-directory: pacs_system
      run: |
        chmod +x ./examples/integration_tests/scripts/*.sh
        cd examples/integration_tests/scripts
        ./run_all_binary_tests.sh --build-dir ../../../build || true

    - name: Upload Binary Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: binary-test-results-${{ matrix.os }}
        path: pacs_system/examples/integration_tests/scripts/test-results/
        retention-days: 30

  stress-tests:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout pacs_system
      uses: actions/checkout@v4
      with:
        path: pacs_system

    - name: Checkout common_system (Tier 0)
      uses: actions/checkout@v4
      with:
        repository: kcenon/common_system
        path: common_system

    - name: Checkout container_system (Tier 1)
      uses: actions/checkout@v4
      with:
        repository: kcenon/container_system
        path: container_system

    - name: Checkout thread_system (Tier 1)
      uses: actions/checkout@v4
      with:
        repository: kcenon/thread_system
        path: thread_system

    - name: Checkout logger_system (Tier 2)
      uses: actions/checkout@v4
      with:
        repository: kcenon/logger_system
        path: logger_system

    - name: Checkout monitoring_system (Tier 3)
      uses: actions/checkout@v4
      with:
        repository: kcenon/monitoring_system
        path: monitoring_system

    - name: Checkout network_system (Tier 4)
      uses: actions/checkout@v4
      with:
        repository: kcenon/network_system
        path: network_system

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev

    - name: Build with stress tests
      working-directory: pacs_system
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DPACS_WARNINGS_AS_ERRORS=OFF \
          -DPACS_BUILD_TESTS=ON \
          -DPACS_BUILD_EXAMPLES=ON \
          -DPACS_BUILD_STORAGE=ON
        cmake --build build -j$(nproc)

    - name: Run Stress Tests
      working-directory: pacs_system
      run: |
        cd build
        mkdir -p test-results
        # Run stress tests with extended timeout
        if [ -f ./bin/pacs_integration_e2e ]; then
          timeout 600 ./bin/pacs_integration_e2e "[stress]" --reporter junit --out test-results/stress-tests.xml || true
        fi

    - name: Upload Stress Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stress-test-results
        path: pacs_system/build/test-results/stress-tests.xml
        retention-days: 30
