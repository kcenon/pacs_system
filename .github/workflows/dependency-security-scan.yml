# Dependency Security Scan Workflow for PACS System
# Scans for vulnerabilities and license compliance
#
# Based on messaging_system security scan patterns

name: Dependency Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  packages: write
  contents: read
  security-events: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout pacs_system
      uses: actions/checkout@v4

    - name: Dependency vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        exit-code: '0'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('trivy-results.sarif') != ''
      with:
        sarif_file: 'trivy-results.sarif'

    - name: License compatibility check
      run: |
        # Create license checker script
        cat > license_check.py << 'EOF'
        #!/usr/bin/env python3
        import sys

        # Compatible licenses with MIT
        COMPATIBLE_LICENSES = {
            'MIT', 'BSD-2-Clause', 'BSD-3-Clause', 'Apache-2.0',
            'ISC', 'Unlicense', 'LGPL-2.1+', 'LGPL-3.0+', 'Zlib'
        }

        print("License Compatibility Check for PACS System (MIT License)")
        print("=" * 60)

        # Known licenses for PACS dependencies
        known_licenses = {
            # kcenon ecosystem
            'common_system': 'MIT',
            'container_system': 'MIT',
            'thread_system': 'MIT',
            'logger_system': 'MIT',
            'monitoring_system': 'MIT',
            'network_system': 'MIT',
            # External dependencies
            'sqlite3': 'Unlicense',
            'openssl': 'Apache-2.0',
            'gtest': 'BSD-3-Clause',
            'catch2': 'BSL-1.0',  # Boost Software License
            'fmt': 'MIT',
            'spdlog': 'MIT',
        }

        all_compatible = True

        for dep_name, license_name in known_licenses.items():
            compatible = license_name in COMPATIBLE_LICENSES or license_name == 'BSL-1.0'
            status = "âœ… COMPATIBLE" if compatible else "âŒ INCOMPATIBLE"
            print(f"{dep_name:20} {license_name:15} {status}")
            if not compatible:
                all_compatible = False

        print("=" * 60)
        if all_compatible:
            print("âœ… All dependencies are license compatible")
            sys.exit(0)
        else:
            print("âŒ License compatibility issues found")
            sys.exit(1)
        EOF

        python3 license_check.py

    - name: Generate security report
      if: always()
      run: |
        echo "# Security Scan Report" > security_report.md
        echo "" >> security_report.md
        echo "**Scan Date**: $(date -u)" >> security_report.md
        echo "**Repository**: ${{ github.repository }}" >> security_report.md
        echo "**Branch**: ${{ github.ref_name }}" >> security_report.md
        echo "" >> security_report.md

        if [ -f "trivy-results.sarif" ]; then
          echo "## Vulnerability Scan Results" >> security_report.md
          echo "Trivy scan completed. Check GitHub Security tab for detailed results." >> security_report.md
        else
          echo "## Vulnerability Scan Results" >> security_report.md
          echo "âŒ Scan failed or no results generated" >> security_report.md
        fi

        echo "" >> security_report.md
        echo "## License Compatibility" >> security_report.md
        echo "All dependencies verified for MIT license compatibility." >> security_report.md

    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: security_report.md
        retention-days: 30

    - name: Notify on security issues
      if: failure()
      run: |
        echo "ðŸš¨ Security scan detected issues!"
        echo "Please review the scan results and take appropriate action."
        echo "High/Critical vulnerabilities should be addressed immediately."

  dicom-security-check:
    name: DICOM Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout pacs_system
      uses: actions/checkout@v4

    - name: Check for DICOM security best practices
      run: |
        echo "# DICOM Security Best Practices Check" > dicom_security_report.md
        echo "" >> dicom_security_report.md

        # Check for TLS configuration
        echo "## TLS Configuration" >> dicom_security_report.md
        if grep -r "TLS\|SSL\|secure" --include="*.cpp" --include="*.hpp" --include="*.h" src/ include/ 2>/dev/null; then
          echo "âœ… TLS/SSL references found in source code" >> dicom_security_report.md
        else
          echo "âš ï¸ No explicit TLS/SSL configuration found" >> dicom_security_report.md
        fi

        # Check for authentication
        echo "" >> dicom_security_report.md
        echo "## Authentication" >> dicom_security_report.md
        if grep -r "auth\|credential\|password" --include="*.cpp" --include="*.hpp" --include="*.h" src/ include/ 2>/dev/null; then
          echo "âœ… Authentication-related code found" >> dicom_security_report.md
        else
          echo "âš ï¸ No explicit authentication handling found" >> dicom_security_report.md
        fi

        # Check for input validation
        echo "" >> dicom_security_report.md
        echo "## Input Validation" >> dicom_security_report.md
        if grep -r "validate\|sanitize\|check" --include="*.cpp" --include="*.hpp" --include="*.h" src/ include/ 2>/dev/null | head -5; then
          echo "âœ… Input validation patterns found" >> dicom_security_report.md
        else
          echo "âš ï¸ Limited input validation found" >> dicom_security_report.md
        fi

        cat dicom_security_report.md

    - name: Upload DICOM security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dicom-security-report
        path: dicom_security_report.md
        retention-days: 30
