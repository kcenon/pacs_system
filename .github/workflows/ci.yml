name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: ${{ matrix.os }} / ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    env:
      BUILD_TYPE: Debug

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            compiler: gcc
            triplet: x64-linux
          - os: ubuntu-22.04
            compiler: clang
            triplet: x64-linux
          - os: macos-13
            compiler: clang
            triplet: x64-osx
          - os: windows-2022
            compiler: msvc
            triplet: x64-windows

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        clean: true
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout thread_system dependency
      uses: actions/checkout@v4
      with:
        repository: kcenon/thread_system
        path: thread_system
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Sources directory structure
      if: runner.os != 'Windows'
      run: |
        mkdir -p /home/$USER/Sources
        mv thread_system /home/$USER/Sources/thread_system || true

    - name: Create Sources directory structure (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path C:\Sources | Out-Null
        if (Test-Path thread_system) {
          Move-Item -Path thread_system -Destination C:\Sources\thread_system -Force
        }

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt update
        sudo apt install -y cmake build-essential gdb pkg-config curl zip unzip tar autoconf automake autoconf-archive ninja-build
        sudo apt install -y clang lld
        sudo apt install -y libgtest-dev libgmock-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install ninja pkg-config curl zip unzip autoconf automake autoconf-archive

    - name: Setup Visual Studio (Windows)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '17.0'
        msbuild-architecture: x64

    - name: Check architecture (Linux)
      if: runner.os == 'Linux'
      run: |
        if [ "$(uname -m)" = "aarch64" ]; then
          echo "VCPKG_FORCE_SYSTEM_BINARIES=arm" >> $GITHUB_ENV
        fi

    - name: Cache vcpkg
      uses: actions/cache@v4
      id: vcpkg-cache
      with:
        path: |
          ${{ github.workspace }}/vcpkg
          !${{ github.workspace }}/vcpkg/buildtrees
          !${{ github.workspace }}/vcpkg/packages
          !${{ github.workspace }}/vcpkg/downloads
        key: ${{ runner.os }}-${{ matrix.compiler }}-vcpkg-${{ hashFiles('vcpkg.json') }}

    - name: Set up vcpkg (Unix)
      if: runner.os != 'Windows'
      run: |
        if [ ! -d "vcpkg" ]; then
          git clone https://github.com/Microsoft/vcpkg.git
        fi
        cd vcpkg
        git pull
        ./bootstrap-vcpkg.sh
        cd ..

    - name: Set up vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (!(Test-Path "vcpkg")) {
          git clone https://github.com/Microsoft/vcpkg.git
        }
        cd vcpkg
        git pull
        .\bootstrap-vcpkg.bat
        cd ..

    - name: Determine vcpkg commit (Unix)
      if: runner.os != 'Windows'
      id: vcpkg-commit-unix
      run: echo "commit=$(git -C vcpkg rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Determine vcpkg commit (Windows)
      if: runner.os == 'Windows'
      id: vcpkg-commit-windows
      shell: pwsh
      run: |
        $commit = git -C vcpkg rev-parse HEAD
        "commit=$commit" >> $env:GITHUB_OUTPUT

    - name: Cache vcpkg installed
      uses: actions/cache@v4
      id: vcpkg-installed
      with:
        path: ${{ github.workspace }}/vcpkg_installed
        key: ${{ runner.os }}-${{ matrix.compiler }}-vcpkg-installed-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}-${{ steps.vcpkg-commit-unix.outputs.commit || steps.vcpkg-commit-windows.outputs.commit }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.compiler }}-vcpkg-installed-${{ matrix.triplet }}-

    - name: Install dependencies with vcpkg (Unix)
      if: runner.os != 'Windows' && steps.vcpkg-installed.outputs.cache-hit != 'true'
      run: |
        ./vcpkg/vcpkg install --x-manifest-root=. --x-install-root=${{ github.workspace }}/vcpkg_installed --triplet ${{ matrix.triplet }}

    - name: Install dependencies with vcpkg (Windows)
      if: runner.os == 'Windows' && steps.vcpkg-installed.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        .\vcpkg\vcpkg install --x-manifest-root=. --x-install-root=${{ github.workspace }}\vcpkg_installed --triplet ${{ matrix.triplet }}

    - name: Prepare build directory
      if: runner.os != 'Windows'
      run: |
        rm -rf build
        mkdir -p build

    - name: Prepare build directory (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        New-Item -ItemType Directory -Path build

    - name: Build application (Unix)
      if: runner.os != 'Windows'
      run: |
        cd build
        cmake .. \
          -G Ninja \
          -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_TOOLCHAIN_FILE="${GITHUB_WORKSPACE}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DCMAKE_C_COMPILER=${{ matrix.compiler == 'gcc' && 'gcc' || 'clang' }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.compiler == 'gcc' && 'g++' || 'clang++' }}

        cmake --build . --parallel

    - name: Build application (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        cd build
        $env:CMAKE_CXX_FLAGS = "/std:c++20 /permissive- /Zc:__cplusplus /EHsc"
        $env:CMAKE_TRY_COMPILE_TARGET_TYPE = "STATIC_LIBRARY"

        cmake .. `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DBUILD_TESTS=ON `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:GITHUB_WORKSPACE\vcpkg\scripts\buildsystems\vcpkg.cmake" `
          -DCMAKE_CXX_FLAGS="/std:c++20 /permissive- /Zc:__cplusplus /EHsc" `
          -DCMAKE_TRY_COMPILE_TARGET_TYPE="STATIC_LIBRARY"

        cmake --build . --config $env:BUILD_TYPE --parallel

    - name: Run tests (Unix)
      if: runner.os != 'Windows'
      run: |
        cd build
        ctest --output-on-failure

    - name: Run tests (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        cd build
        ctest -C $env:BUILD_TYPE --output-on-failure

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.compiler }}
        path: build/Testing/
        retention-days: 7
